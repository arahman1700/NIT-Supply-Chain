<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>NESMA | Assets Management Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/nesma-theme.css">
    <script src="assets/nesma-utils.js"></script>
    <style>
        :root {
            --nesma-primary: #2E3192;
            --nesma-cyan: #80D1E9;
            --nesma-navy: #0E2841;
            --nesma-light-gray: #E8E8E8;
            --success: #059669;
            --warning: #D97706;
            --danger: #DC2626;
        }
        * { font-family: 'Inter', 'Cairo', sans-serif; }
        body { background: #F2F2F4; min-height: 100vh; }
        .nesma-header { background: linear-gradient(90deg, #0E2841 0%, #2E3192 45%, #5B2D8E 100%); position: relative; }
        .nesma-header::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, #80D1E9 0%, #DEC18C 100%); }
        .card { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(14,40,65,0.08); border: 1px solid var(--nesma-light-gray); }
        .overview-card { position: relative; border-radius: 16px; padding: 20px; color: white; overflow: hidden; cursor: pointer; transition: all 0.3s ease; }
        .overview-card::before { content: ''; position: absolute; top: 0; right: 0; width: 50%; height: 100%; background: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, transparent 100%); }
        .overview-card:hover { transform: translateY(-4px); box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .overview-card .icon { width: 50px; height: 50px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-bottom: 12px; }
        .overview-card .value { font-size: 2rem; font-weight: 800; }
        .overview-card .label { font-size: 0.85rem; opacity: 0.9; }
        .overview-card .sub { font-size: 0.75rem; opacity: 0.7; margin-top: 4px; }
        .bg-equipment { background: linear-gradient(135deg, #2E3192 0%, #5B2D8E 100%); }
        .bg-fleet { background: linear-gradient(135deg, #10B981 0%, #047857 100%); }
        .bg-generators { background: linear-gradient(135deg, #2E3192 0%, #5B2D8E 100%); }
        .bg-acs { background: linear-gradient(135deg, #06B6D4 0%, #0E7490 100%); }
        .bg-testing { background: linear-gradient(135deg, #8B5CF6 0%, #6D28D9 100%); }
        .bg-tools { background: linear-gradient(135deg, #EF4444 0%, #B91C1C 100%); }
        .tab-btn { transition: all 0.2s ease; font-weight: 500; color: #B3B3B3; border-bottom: 3px solid transparent; background: transparent; }
        .tab-btn.active { color: var(--nesma-primary); border-bottom-color: var(--nesma-primary); background: rgba(46,49,146,0.05); }
        .tab-btn:hover:not(.active) { color: var(--nesma-navy); background: rgba(128,209,233,0.1); }
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .chart-container { position: relative; height: 300px; }
        .data-table { width: 100%; border-collapse: separate; border-spacing: 0; }
        .data-table th { background: var(--nesma-primary); padding: 12px 16px; font-weight: 600; color: white; position: sticky; top: 0; z-index: 10; text-transform: uppercase; font-size: 0.7rem; letter-spacing: 0.05em; }
        .data-table th:first-child { border-radius: 8px 0 0 0; }
        .data-table th:last-child { border-radius: 0 8px 0 0; }
        .data-table td { padding: 10px 14px; border-bottom: 1px solid var(--nesma-light-gray); font-size: 0.8rem; }
        .data-table tr:hover td { background: rgba(128,209,233,0.08); }
        .data-table tr:nth-child(even) td { background: rgba(248,250,252,0.5); }
        .scroll-container { max-height: 450px; overflow-y: auto; border-radius: 8px; border: 1px solid var(--nesma-light-gray); }
        .scroll-container::-webkit-scrollbar { width: 6px; }
        .scroll-container::-webkit-scrollbar-track { background: #f1f1f1; }
        .scroll-container::-webkit-scrollbar-thumb { background: var(--nesma-cyan); border-radius: 4px; }
        .badge { display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 6px; font-size: 0.7rem; font-weight: 600; }
        .badge-danger { background: #FEE2E2; color: #DC2626; }
        .badge-warning { background: #FEF3C7; color: #D97706; }
        .badge-success { background: #D1FAE5; color: #059669; }
        .badge-info { background: #DBEAFE; color: #2563EB; }
        .badge-purple { background: #EDE9FE; color: #7C3AED; }
        .filter-section { background: linear-gradient(135deg, #F2F2F4 0%, #F1F5F9 100%); border-radius: 12px; padding: 16px; margin-bottom: 20px; border: 1px solid var(--nesma-light-gray); }
        .filter-select { border: 1px solid var(--nesma-light-gray); border-radius: 8px; padding: 8px 12px; font-size: 0.85rem; background: white; min-width: 150px; transition: all 0.2s; }
        .filter-select:focus { outline: none; border-color: var(--nesma-primary); box-shadow: 0 0 0 3px rgba(46,49,146,0.1); }
        .btn-export { display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; border-radius: 8px; font-size: 0.85rem; font-weight: 500; transition: all 0.2s ease; }
        .btn-excel { background: #059669; color: white; }
        .btn-excel:hover { background: #047857; transform: translateY(-1px); }
        .search-box { position: relative; }
        .search-box input { width: 100%; padding: 10px 40px 10px 14px; border: 1px solid var(--nesma-light-gray); border-radius: 8px; font-size: 0.85rem; }
        .search-box input:focus { outline: none; border-color: var(--nesma-primary); box-shadow: 0 0 0 3px rgba(46,49,146,0.1); }
        .search-box svg { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #9CA3AF; }
        .kpi-mini { background: white; border-radius: 12px; padding: 16px; border: 1px solid var(--nesma-light-gray); transition: all 0.2s; }
        .kpi-mini:hover { box-shadow: 0 8px 16px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .kpi-mini .value { font-size: 1.5rem; font-weight: 700; color: var(--nesma-primary); }
        .kpi-mini .label { font-size: 0.75rem; color: #6B7280; }
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body>
    <header class="nesma-header text-white no-print">
        <div class="container mx-auto px-4 lg:px-6">
            <div class="flex items-center justify-between py-4">
                <div class="flex items-center gap-4">
                    <a href="index.html" class="flex items-center gap-2 text-white/80 hover:text-white">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
                        <span class="text-sm font-medium hidden sm:inline">Back</span>
                    </a>
                    <div class="h-6 w-px bg-white/20"></div>
                    <img src="assets/logo-white.svg" alt="NESMA" class="h-8 lg:h-10">
                </div>
                <div class="text-center flex-1 px-4">
                    <h1 class="text-lg lg:text-xl font-bold">Assets Management Dashboard</h1>
                    <p class="text-xs lg:text-sm text-white/70 hidden sm:block">Equipment, Fleet, Generators & Tools Tracking</p>
                </div>
                <div class="flex items-center gap-3">
                    <span class="text-xs text-white/60 hidden md:inline" id="lastUpdated">Loading...</span>
                    <button id="themeToggleBtn" onclick="NesmaTheme.toggle()" class="p-2 hover:bg-white/10 rounded-lg transition-colors" title="Toggle Theme">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 lg:px-6 py-6">
        <section class="mb-8">
            <h2 class="text-lg font-bold text-gray-800 mb-4">Assets Overview</h2>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4" id="overviewCards"></div>
        </section>

        <div class="card">
            <div class="border-b border-gray-200 overflow-x-auto no-print">
                <div class="flex min-w-max">
                    <button class="tab-btn active px-4 lg:px-5 py-3 font-semibold whitespace-nowrap text-sm" onclick="switchTab('equipment')">Equipment <span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full ml-1" id="equipmentBadge">0</span></button>
                    <button class="tab-btn px-4 lg:px-5 py-3 font-semibold whitespace-nowrap text-sm" onclick="switchTab('fleet')">Fleet <span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full ml-1" id="fleetBadge">0</span></button>
                    <button class="tab-btn px-4 lg:px-5 py-3 font-semibold whitespace-nowrap text-sm" onclick="switchTab('generators')">Generators <span class="text-xs bg-amber-100 text-amber-700 px-2 py-0.5 rounded-full ml-1" id="generatorsBadge">0</span></button>
                    <button class="tab-btn px-4 lg:px-5 py-3 font-semibold whitespace-nowrap text-sm" onclick="switchTab('acs')">Stand ACs <span class="text-xs bg-cyan-100 text-cyan-700 px-2 py-0.5 rounded-full ml-1" id="acsBadge">0</span></button>
                    <button class="tab-btn px-4 lg:px-5 py-3 font-semibold whitespace-nowrap text-sm" onclick="switchTab('testing')">Testing Equip <span class="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full ml-1" id="testingBadge">0</span></button>
                    <button class="tab-btn px-4 lg:px-5 py-3 font-semibold whitespace-nowrap text-sm" onclick="switchTab('tools')">Tools <span class="text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded-full ml-1" id="toolsBadge">0</span></button>
                </div>
            </div>

            <div id="tab-equipment" class="tab-content active p-4 lg:p-6">
                <div class="filter-section no-print">
                    <div class="flex flex-wrap items-end gap-4">
                        <div class="flex-1 min-w-[200px]"><label class="block text-xs font-medium text-gray-500 mb-1">Search</label><div class="search-box"><input type="text" id="equipmentSearch" placeholder="Search equipment..." onkeyup="filterEquipment()"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg></div></div>
                        <div><label class="block text-xs font-medium text-gray-500 mb-1">City</label><select id="filterEquipmentCity" class="filter-select" onchange="filterEquipment()"><option value="">All Cities</option></select></div>
                        <div><label class="block text-xs font-medium text-gray-500 mb-1">Status</label><select id="filterEquipmentStatus" class="filter-select" onchange="filterEquipment()"><option value="">All Statuses</option></select></div>
                        <button onclick="exportToExcel('equipment')" class="btn-export btn-excel">Excel</button>
                        <button onclick="NesmaExport.toCSV(filteredData.equipment,'Equipment')" class="btn-export btn-csv">CSV</button>
                        <button onclick="NesmaExport.toPDF('tab-equipment','Assets_Equipment')" class="btn-export btn-pdf">PDF</button>
                    </div>
                </div>
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6" id="equipmentKPIs"></div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="card p-4"><h3 class="font-semibold text-gray-800 mb-4">Equipment by City</h3><div class="chart-container"><canvas id="equipmentByCityChart"></canvas></div></div>
                    <div class="card p-4"><h3 class="font-semibold text-gray-800 mb-4">Equipment by Brand</h3><div class="chart-container"><canvas id="equipmentByBrandChart"></canvas></div></div>
                </div>
                <div class="card"><div class="p-4 border-b border-gray-200 flex justify-between items-center"><h3 class="font-semibold text-gray-800">Equipment List</h3><span class="text-sm text-gray-500" id="equipmentCount">0 items</span></div><div class="scroll-container"><table class="data-table"><thead><tr><th>#</th><th>Description</th><th>Brand</th><th>Capacity</th><th>City</th><th>Project</th><th>Responsible</th><th>Status</th><th>Cost (SAR)</th></tr></thead><tbody id="equipmentTableBody"></tbody></table></div></div>
            </div>

            <div id="tab-fleet" class="tab-content p-4 lg:p-6">
                <div class="filter-section no-print">
                    <div class="flex flex-wrap items-end gap-4">
                        <div class="flex-1 min-w-[200px]"><label class="block text-xs font-medium text-gray-500 mb-1">Search</label><div class="search-box"><input type="text" id="fleetSearch" placeholder="Search vehicles..." onkeyup="filterFleet()"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg></div></div>
                        <div><label class="block text-xs font-medium text-gray-500 mb-1">Type</label><select id="filterFleetType" class="filter-select" onchange="filterFleet()"><option value="">All Types</option></select></div>
                        <div><label class="block text-xs font-medium text-gray-500 mb-1">Region</label><select id="filterFleetRegion" class="filter-select" onchange="filterFleet()"><option value="">All Regions</option></select></div>
                        <div><label class="block text-xs font-medium text-gray-500 mb-1">Make</label><select id="filterFleetMake" class="filter-select" onchange="filterFleet()"><option value="">All Makes</option></select></div>
                        <button onclick="exportToExcel('fleet')" class="btn-export btn-excel">Excel</button>
                        <button onclick="NesmaExport.toCSV(filteredData.fleet,'Fleet')" class="btn-export btn-csv">CSV</button>
                        <button onclick="NesmaExport.toPDF('tab-fleet','Assets_Fleet')" class="btn-export btn-pdf">PDF</button>
                    </div>
                </div>
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6" id="fleetKPIs"></div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="card p-4"><h3 class="font-semibold text-gray-800 mb-4">Fleet by Vehicle Type</h3><div class="chart-container"><canvas id="fleetByTypeChart"></canvas></div></div>
                    <div class="card p-4"><h3 class="font-semibold text-gray-800 mb-4">Fleet by Region</h3><div class="chart-container"><canvas id="fleetByRegionChart"></canvas></div></div>
                </div>
                <div class="card"><div class="p-4 border-b border-gray-200 flex justify-between items-center"><h3 class="font-semibold text-gray-800">Fleet List</h3><span class="text-sm text-gray-500" id="fleetCount">0 vehicles</span></div><div class="scroll-container"><table class="data-table"><thead><tr><th>#</th><th>Plate No.</th><th>Make/Model</th><th>Type</th><th>Year</th><th>Region</th><th>City</th><th>User</th><th>Status</th></tr></thead><tbody id="fleetTableBody"></tbody></table></div></div>
            </div>

            <div id="tab-generators" class="tab-content p-4 lg:p-6">
                <!-- NIT vs Rental Comparison Cards - NESMA Colors -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- NIT Card - NESMA Primary Blue -->
                    <div class="relative rounded-2xl p-6 text-white overflow-hidden" style="background: linear-gradient(135deg, #2E3192 0%, #0E2841 100%);">
                        <div class="absolute top-0 right-0 w-40 h-40 rounded-full -translate-y-1/2 translate-x-1/2" style="background: rgba(128,209,233,0.15);"></div>
                        <div class="absolute bottom-0 left-0 w-24 h-24 rounded-full translate-y-1/2 -translate-x-1/2" style="background: rgba(222,193,140,0.1);"></div>
                        <div class="flex justify-between items-start mb-4 relative z-10">
                            <div>
                                <h3 class="text-xl font-bold flex items-center gap-2">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                                    NIT Owned
                                </h3>
                                <p class="text-sm opacity-80">Company Assets</p>
                            </div>
                            <div class="text-right">
                                <div class="text-4xl font-black" id="nitTotal" style="color: #80D1E9;">0</div>
                                <div class="text-xs opacity-80">Generators</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3 mb-4 relative z-10">
                            <div class="rounded-xl p-3 text-center" style="background: rgba(128,209,233,0.2);">
                                <div class="text-2xl font-bold" id="nitActive" style="color: #80D1E9;">0</div>
                                <div class="text-xs opacity-90">Active</div>
                            </div>
                            <div class="rounded-xl p-3 text-center" style="background: rgba(222,193,140,0.2);">
                                <div class="text-2xl font-bold" id="nitOverhaul" style="color: #DEC18C;">0</div>
                                <div class="text-xs opacity-90">Overhaul</div>
                            </div>
                            <div class="rounded-xl p-3 text-center" style="background: rgba(128,209,233,0.2);">
                                <div class="text-2xl font-bold" id="nitGood" style="color: #80D1E9;">0</div>
                                <div class="text-xs opacity-90">Good</div>
                            </div>
                            <div class="rounded-xl p-3 text-center" style="background: rgba(173,128,130,0.3);">
                                <div class="text-2xl font-bold" id="nitMaintenance" style="color: #FFB4B4;">0</div>
                                <div class="text-xs opacity-90">Needs Attention</div>
                            </div>
                        </div>
                        <div class="flex justify-between text-sm border-t border-white/20 pt-3 relative z-10">
                            <span>Total kW: <strong id="nitKW" style="color: #80D1E9;">0</strong></span>
                            <span>Total Value: <strong id="nitCost" style="color: #DEC18C;">0</strong> SAR</span>
                        </div>
                    </div>
                    <!-- Rental Card - NESMA Complementary -->
                    <div class="relative rounded-2xl p-6 text-white overflow-hidden" style="background: linear-gradient(135deg, #5B2D8E 0%, #3D1F5F 100%);">
                        <div class="absolute top-0 right-0 w-40 h-40 rounded-full -translate-y-1/2 translate-x-1/2" style="background: rgba(222,193,140,0.15);"></div>
                        <div class="absolute bottom-0 left-0 w-24 h-24 rounded-full translate-y-1/2 -translate-x-1/2" style="background: rgba(128,209,233,0.1);"></div>
                        <div class="flex justify-between items-start mb-4 relative z-10">
                            <div>
                                <h3 class="text-xl font-bold flex items-center gap-2">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/></svg>
                                    Rental
                                </h3>
                                <p class="text-sm opacity-80">Leased Equipment</p>
                            </div>
                            <div class="text-right">
                                <div class="text-4xl font-black" id="rentalTotal" style="color: #DEC18C;">0</div>
                                <div class="text-xs opacity-80">Generators</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3 mb-4 relative z-10">
                            <div class="rounded-xl p-3 text-center" style="background: rgba(222,193,140,0.2);">
                                <div class="text-2xl font-bold" id="rentalActive" style="color: #DEC18C;">0</div>
                                <div class="text-xs opacity-90">Active</div>
                            </div>
                            <div class="rounded-xl p-3 text-center" style="background: rgba(128,209,233,0.2);">
                                <div class="text-2xl font-bold" id="rentalDemobilized" style="color: #80D1E9;">0</div>
                                <div class="text-xs opacity-90">Demobilized</div>
                            </div>
                            <div class="rounded-xl p-3 text-center" style="background: rgba(222,193,140,0.2);">
                                <div class="text-2xl font-bold" id="rentalGood" style="color: #DEC18C;">0</div>
                                <div class="text-xs opacity-90">Good</div>
                            </div>
                            <div class="rounded-xl p-3 text-center" style="background: rgba(173,128,130,0.25);">
                                <div class="text-2xl font-bold" id="rentalMaintenance" style="color: #FFB4B4;">0</div>
                                <div class="text-xs opacity-90">Needs Attention</div>
                            </div>
                        </div>
                        <div class="flex justify-between text-sm border-t border-white/20 pt-3 relative z-10">
                            <span>Total kW: <strong id="rentalKW" style="color: #80D1E9;">0</strong></span>
                            <span>Rental Cost: <strong id="rentalCost" style="color: #DEC18C;">0</strong> SAR</span>
                        </div>
                    </div>
                </div>

                <!-- Filter Section -->
                <div class="filter-section no-print mb-6">
                    <div class="flex flex-wrap items-end gap-4">
                        <div class="flex-1 min-w-[180px]"><label class="block text-xs font-medium text-gray-500 mb-1">Search</label><div class="search-box"><input type="text" id="generatorSearch" placeholder="Search generators..." onkeyup="filterGenerators()"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg></div></div>
                        <div><label class="block text-xs font-medium text-gray-500 mb-1">Type</label><select id="filterGenType" class="filter-select" onchange="filterGenerators()"><option value="">All Types</option><option value="NIT">NIT</option><option value="Rental">Rental</option><option value="Unknown">Unknown</option></select></div>
                        <div><label class="block text-xs font-medium text-gray-500 mb-1">Capacity (KVA)</label><select id="filterGenCapacity" class="filter-select" onchange="filterGenerators()"><option value="">All Capacities</option></select></div>
                        <div><label class="block text-xs font-medium text-gray-500 mb-1">Location</label><select id="filterGenLocation" class="filter-select" onchange="filterGenerators()"><option value="">All Locations</option></select></div>
                        <div><label class="block text-xs font-medium text-gray-500 mb-1">Condition</label><select id="filterGenCondition" class="filter-select" onchange="filterGenerators()"><option value="">All Conditions</option><option value="Good">Good</option><option value="Needs Maintenance">Needs Maintenance</option><option value="Not Working">Not Working</option><option value="Bad">Bad</option></select></div>
                        <div><label class="block text-xs font-medium text-gray-500 mb-1">Status</label><select id="filterGenStatus" class="filter-select" onchange="filterGenerators()"><option value="">All Statuses</option></select></div>
                        <button onclick="resetGenFilters()" class="btn-export" style="background:#6B7280;color:white;">Reset</button>
                        <button onclick="exportToExcel('generators')" class="btn-export btn-excel">Excel</button>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="card p-4"><h3 class="font-semibold text-gray-800 mb-4">NIT vs Rental Comparison</h3><div class="chart-container"><canvas id="genComparisonChart"></canvas></div></div>
                    <div class="card p-4"><h3 class="font-semibold text-gray-800 mb-4">Condition Analysis</h3><div class="chart-container"><canvas id="genConditionChart"></canvas></div></div>
                </div>
                <div class="card p-4 mb-6"><h3 class="font-semibold text-gray-800 mb-4">Top Locations by Capacity (kW)</h3><div class="chart-container"><canvas id="generatorsByLocationChart"></canvas></div></div>

                <!-- Generators Table -->
                <div class="card"><div class="p-4 border-b border-gray-200 flex justify-between items-center"><h3 class="font-semibold text-gray-800">Generator List</h3><span class="text-sm text-gray-500" id="generatorCount">0 generators</span></div><div class="scroll-container"><table class="data-table"><thead><tr><th>#</th><th>Type</th><th>Name/Brand</th><th>Capacity</th><th>Max kW</th><th>Location</th><th>Condition</th><th>Responsible</th><th>Status</th><th>Cost</th></tr></thead><tbody id="generatorTableBody"></tbody></table></div></div>
            </div>

            <div id="tab-acs" class="tab-content p-4 lg:p-6">
                <div class="filter-section no-print">
                    <div class="flex flex-wrap items-end gap-4">
                        <div class="flex-1 min-w-[200px]"><label class="block text-xs font-medium text-gray-500 mb-1">Search</label><div class="search-box"><input type="text" id="acsSearch" placeholder="Search AC units..." onkeyup="filterACs()"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg></div></div>
                        <div><label class="block text-xs font-medium text-gray-500 mb-1">Project</label><select id="filterAcsProject" class="filter-select" onchange="filterACs()"><option value="">All Projects</option></select></div>
                        <div><label class="block text-xs font-medium text-gray-500 mb-1">Status</label><select id="filterAcsStatus" class="filter-select" onchange="filterACs()"><option value="">All Statuses</option></select></div>
                        <button onclick="exportToExcel('acs')" class="btn-export btn-excel">Excel</button>
                        <button onclick="NesmaExport.toCSV(filteredData.acs,'Stand_ACs')" class="btn-export btn-csv">CSV</button>
                        <button onclick="NesmaExport.toPDF('tab-acs','Assets_StandACs')" class="btn-export btn-pdf">PDF</button>
                    </div>
                </div>
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6" id="acsKPIs"></div>
                <div class="card"><div class="p-4 border-b border-gray-200 flex justify-between items-center"><h3 class="font-semibold text-gray-800">Stand AC Units</h3><span class="text-sm text-gray-500" id="acsCount">0 units</span></div><div class="scroll-container"><table class="data-table"><thead><tr><th>#</th><th>Description</th><th>Project Code</th><th>Capacity</th><th>Required</th><th>Available</th><th>Cost (SAR)</th><th>Status</th></tr></thead><tbody id="acsTableBody"></tbody></table></div></div>
            </div>

            <div id="tab-testing" class="tab-content p-4 lg:p-6">
                <div class="filter-section no-print">
                    <div class="flex flex-wrap items-end gap-4">
                        <div class="flex-1 min-w-[200px]"><label class="block text-xs font-medium text-gray-500 mb-1">Search</label><div class="search-box"><input type="text" id="testingSearch" placeholder="Search equipment..." onkeyup="filterTesting()"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg></div></div>
                        <div><label class="block text-xs font-medium text-gray-500 mb-1">Supplier</label><select id="filterTestingSupplier" class="filter-select" onchange="filterTesting()"><option value="">All Suppliers</option></select></div>
                        <div><label class="block text-xs font-medium text-gray-500 mb-1">Location</label><select id="filterTestingLocation" class="filter-select" onchange="filterTesting()"><option value="">All Locations</option></select></div>
                        <div><label class="block text-xs font-medium text-gray-500 mb-1">TUV Status</label><select id="filterTestingTUV" class="filter-select" onchange="filterTesting()"><option value="">All TUV</option></select></div>
                        <button onclick="exportToExcel('testing')" class="btn-export btn-excel">Excel</button>
                        <button onclick="NesmaExport.toCSV(filteredData.testing,'Testing_Equipment')" class="btn-export btn-csv">CSV</button>
                        <button onclick="NesmaExport.toPDF('tab-testing','Assets_TestingEquipment')" class="btn-export btn-pdf">PDF</button>
                    </div>
                </div>
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6" id="testingKPIs"></div>
                <div class="card"><div class="p-4 border-b border-gray-200 flex justify-between items-center"><h3 class="font-semibold text-gray-800">Testing & Commission Equipment</h3><span class="text-sm text-gray-500" id="testingCount">0 items</span></div><div class="scroll-container"><table class="data-table"><thead><tr><th>#</th><th>Description</th><th>Supplier</th><th>Location</th><th>TUV</th><th>Calibration</th><th>Qty</th><th>Total (SAR)</th></tr></thead><tbody id="testingTableBody"></tbody></table></div></div>
            </div>

            <div id="tab-tools" class="tab-content p-4 lg:p-6">
                <div class="filter-section no-print">
                    <div class="flex flex-wrap items-end gap-4">
                        <div class="flex-1 min-w-[200px]"><label class="block text-xs font-medium text-gray-500 mb-1">Search</label><div class="search-box"><input type="text" id="toolsSearch" placeholder="Search tools..." onkeyup="filterTools()"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg></div></div>
                        <div><label class="block text-xs font-medium text-gray-500 mb-1">Type</label><select id="filterToolType" class="filter-select" onchange="filterTools()"><option value="">All Types</option></select></div>
                        <div><label class="block text-xs font-medium text-gray-500 mb-1">Location</label><select id="filterToolLocation" class="filter-select" onchange="filterTools()"><option value="">All Locations</option></select></div>
                        <button onclick="exportToExcel('tools')" class="btn-export btn-excel">Excel</button>
                        <button onclick="NesmaExport.toCSV(filteredData.tools,'Tools')" class="btn-export btn-csv">CSV</button>
                        <button onclick="NesmaExport.toPDF('tab-tools','Assets_Tools')" class="btn-export btn-pdf">PDF</button>
                    </div>
                </div>
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6" id="toolsKPIs"></div>
                <div class="card"><div class="p-4 border-b border-gray-200 flex justify-between items-center"><h3 class="font-semibold text-gray-800">Tools List</h3><span class="text-sm text-gray-500" id="toolsCount">0 tools</span></div><div class="scroll-container"><table class="data-table"><thead><tr><th>#</th><th>Description</th><th>Type</th><th>Supplier</th><th>Measurement</th><th>Location</th><th>Qty</th><th>TUV Status</th></tr></thead><tbody id="toolsTableBody"></tbody></table></div></div>
            </div>
        </div>
    </main>

    <script>
        let assetsData = null;
        let charts = {};
        let filteredData = {};

        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.textContent;
        }

        async function loadData() {
            try {
                const response = await fetch('data/assets_data.json?t=' + Date.now());
                assetsData = await response.json();
                document.getElementById('lastUpdated').textContent = 'Updated: ' + new Date(assetsData.last_updated).toLocaleString();
                document.getElementById('equipmentBadge').textContent = assetsData.summary.equipment.total;
                document.getElementById('fleetBadge').textContent = assetsData.summary.fleet.total;
                document.getElementById('generatorsBadge').textContent = assetsData.summary.generators.total;
                document.getElementById('acsBadge').textContent = assetsData.summary.stand_acs.total;
                document.getElementById('testingBadge').textContent = assetsData.summary.testing_equipment.total;
                document.getElementById('toolsBadge').textContent = assetsData.summary.tools.total;
                renderOverviewCards();
                populateFilters();
                initAllTabs();
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        function renderOverviewCards() {
            const s = assetsData.summary;
            const container = document.getElementById('overviewCards');
            container.textContent = '';
            const cards = [
                { cls: 'bg-equipment', label: 'Equipment', value: s.equipment.total, sub: 'SAR ' + (s.equipment.total_cost/1e6).toFixed(1) + 'M', dataKey: 'equipment', cols: [{key:'description',label:'Description'},{key:'brand',label:'Brand'},{key:'city',label:'City'},{key:'project',label:'Project'},{key:'status',label:'Status'},{key:'cost',label:'Cost',align:'right'}] },
                { cls: 'bg-fleet', label: 'Fleet Vehicles', value: s.fleet.total, sub: 'SAR ' + (s.fleet.total_cost/1e6).toFixed(1) + 'M', dataKey: 'fleet', cols: [{key:'plate_no_eng',label:'Plate'},{key:'make',label:'Make'},{key:'model',label:'Model'},{key:'vehicle_type',label:'Type'},{key:'region',label:'Region'},{key:'availability',label:'Status'}] },
                { cls: 'bg-generators', label: 'Generators', value: s.generators.total, sub: s.generators.total_capacity_kw.toLocaleString() + ' kW', dataKey: 'generators', cols: [{key:'name',label:'Name'},{key:'type',label:'Type'},{key:'max_kw',label:'Max kW',align:'right'},{key:'location',label:'Location'},{key:'status',label:'Status'}] },
                { cls: 'bg-acs', label: 'Stand ACs', value: s.stand_acs.total, sub: s.stand_acs.total_available + ' available', dataKey: 'acs', cols: [{key:'description',label:'Description'},{key:'project_code',label:'Project'},{key:'capacity',label:'Capacity'},{key:'qty_available',label:'Available',align:'right'},{key:'cost',label:'Cost',align:'right'}] },
                { cls: 'bg-testing', label: 'Testing Equip', value: s.testing_equipment.total, sub: 'SAR ' + (s.testing_equipment.total_value/1e6).toFixed(1) + 'M', dataKey: 'testing', cols: [{key:'description',label:'Description'},{key:'supplier',label:'Supplier'},{key:'location',label:'Location'},{key:'tuv',label:'TUV'},{key:'qty',label:'Qty',align:'right'},{key:'total_price',label:'Value',align:'right'}] },
                { cls: 'bg-tools', label: 'Tools', value: s.tools.total, sub: s.tools.total_qty.toLocaleString() + ' qty', dataKey: 'tools', cols: [{key:'description',label:'Description'},{key:'type',label:'Type'},{key:'supplier',label:'Supplier'},{key:'location',label:'Location'},{key:'quantity',label:'Qty',align:'right'},{key:'tuv_status',label:'TUV'}] }
            ];
            cards.forEach(c => {
                const div = document.createElement('div');
                div.className = 'overview-card ' + c.cls;
                div.onclick = function() {
                    if (c.dataKey === 'generators') {
                        // For generators, switch to tab to use full filtering
                        switchTab('generators');
                    } else {
                        NesmaModal.show('All ' + c.label, filteredData[c.dataKey], c.cols, filteredData[c.dataKey].length + ' records');
                    }
                };
                const valueEl = document.createElement('div');
                valueEl.className = 'value';
                valueEl.textContent = c.value.toLocaleString();
                const labelEl = document.createElement('div');
                labelEl.className = 'label';
                labelEl.textContent = c.label;
                const subEl = document.createElement('div');
                subEl.className = 'sub';
                subEl.textContent = c.sub;
                div.appendChild(valueEl);
                div.appendChild(labelEl);
                div.appendChild(subEl);
                container.appendChild(div);
            });
        }

        function populateFilters() {
            const f = assetsData.filters;
            populateSelect('filterEquipmentCity', f.equipment_cities);
            populateSelect('filterEquipmentStatus', f.equipment_statuses);
            populateSelect('filterFleetType', f.fleet_vehicle_types);
            populateSelect('filterFleetRegion', f.fleet_regions);
            populateSelect('filterFleetMake', f.fleet_makes);
            populateSelect('filterGenLocation', f.generator_locations);
            populateSelect('filterGenStatus', f.generator_statuses);
            // Capacity filter - get from summary or calculate
            var genCapacities = [...new Set(assetsData.records.generators.map(r => r.capacity).filter(Boolean))].sort((a,b) => parseInt(a) - parseInt(b));
            populateSelect('filterGenCapacity', genCapacities);
            populateSelect('filterToolType', f.tool_types);
            // New filters
            var acsProjects = [...new Set(assetsData.records.stand_acs.map(r => r.project_code).filter(Boolean))].sort();
            var acsStatuses = [...new Set(assetsData.records.stand_acs.map(r => r.status).filter(Boolean))].sort();
            populateSelect('filterAcsProject', acsProjects);
            populateSelect('filterAcsStatus', acsStatuses);
            var testingSuppliers = [...new Set(assetsData.records.testing_equipment.map(r => r.supplier).filter(Boolean))].sort();
            var testingLocations = [...new Set(assetsData.records.testing_equipment.map(r => r.location).filter(Boolean))].sort();
            var testingTUVs = [...new Set(assetsData.records.testing_equipment.map(r => r.tuv).filter(Boolean))].sort();
            populateSelect('filterTestingSupplier', testingSuppliers);
            populateSelect('filterTestingLocation', testingLocations);
            populateSelect('filterTestingTUV', testingTUVs);
            var toolLocations = [...new Set(assetsData.records.tools.map(r => r.location).filter(Boolean))].sort();
            populateSelect('filterToolLocation', toolLocations);
        }

        function populateSelect(id, options) {
            const select = document.getElementById(id);
            if (!select) return;
            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                select.appendChild(option);
            });
        }

        function initAllTabs() {
            filteredData.equipment = [...assetsData.records.equipment];
            filteredData.fleet = [...assetsData.records.fleet];
            filteredData.generators = [...assetsData.records.generators];
            filteredData.acs = [...assetsData.records.stand_acs];
            filteredData.testing = [...assetsData.records.testing_equipment];
            filteredData.tools = [...assetsData.records.tools];
            renderEquipmentTab();
            renderFleetTab();
            renderGeneratorsTab();
            renderACsTab();
            renderTestingTab();
            renderToolsTab();
        }

        function filterEquipment() {
            const search = document.getElementById('equipmentSearch').value.toLowerCase();
            const city = document.getElementById('filterEquipmentCity').value;
            const status = document.getElementById('filterEquipmentStatus').value;
            filteredData.equipment = assetsData.records.equipment.filter(r => {
                const matchSearch = !search || r.description.toLowerCase().includes(search) || r.brand.toLowerCase().includes(search);
                const matchCity = !city || r.city === city;
                const matchStatus = !status || r.status === status;
                return matchSearch && matchCity && matchStatus;
            });
            renderEquipmentTab();
        }

        function renderEquipmentTab() {
            const data = filteredData.equipment;
            const total = data.length;
            const totalCost = data.reduce((s, r) => s + r.cost, 0);
            const active = data.filter(r => r.status === 'Active').length;
            const cities = new Set(data.map(r => r.city).filter(c => c)).size;

            const equipCols = [{key:'description',label:'Description'},{key:'brand',label:'Brand'},{key:'city',label:'City'},{key:'project',label:'Project'},{key:'responsible',label:'Responsible'},{key:'status',label:'Status'},{key:'cost',label:'Cost',align:'right'}];
            const kpisContainer = document.getElementById('equipmentKPIs');
            kpisContainer.textContent = '';
            [
                { value: total, label: 'Total Equipment', click: function() { NesmaModal.show('All Equipment', data, equipCols); } },
                { value: active, label: 'Active Units', color: '#059669', click: function() { NesmaModal.show('Active Equipment', data.filter(function(r){return r.status==='Active';}), equipCols); } },
                { value: cities, label: 'Cities', click: function() { var cityStats = {}; data.forEach(function(r){ if(r.city){ if(!cityStats[r.city]) cityStats[r.city]={city:r.city,count:0,cost:0}; cityStats[r.city].count++; cityStats[r.city].cost+=r.cost; }}); NesmaModal.show('Equipment by City', Object.values(cityStats), [{key:'city',label:'City'},{key:'count',label:'Count',align:'right'},{key:'cost',label:'Total Cost',align:'right'}]); } },
                { value: 'SAR ' + (totalCost/1e6).toFixed(2) + 'M', label: 'Total Value', click: function() { NesmaModal.show('Equipment by Value', data.slice().sort(function(a,b){return b.cost-a.cost;}), equipCols, 'SAR ' + totalCost.toLocaleString() + ' total'); } }
            ].forEach(k => {
                const div = document.createElement('div');
                div.className = 'kpi-mini';
                div.style.cursor = 'pointer';
                if (k.click) div.onclick = k.click;
                const val = document.createElement('div');
                val.className = 'value';
                val.textContent = typeof k.value === 'number' ? k.value.toLocaleString() : k.value;
                if (k.color) val.style.color = k.color;
                const lbl = document.createElement('div');
                lbl.className = 'label';
                lbl.textContent = k.label;
                div.appendChild(val);
                div.appendChild(lbl);
                kpisContainer.appendChild(div);
            });

            // Charts
            const cityData = {};
            const brandData = {};
            data.forEach(r => {
                if (r.city) cityData[r.city] = (cityData[r.city] || 0) + 1;
                if (r.brand) brandData[r.brand] = (brandData[r.brand] || 0) + 1;
            });
            const citySorted = Object.entries(cityData).sort((a, b) => b[1] - a[1]).slice(0, 10);
            const brandSorted = Object.entries(brandData).sort((a, b) => b[1] - a[1]).slice(0, 8);

            if (charts.equipmentByCity) charts.equipmentByCity.destroy();
            charts.equipmentByCity = new Chart(document.getElementById('equipmentByCityChart').getContext('2d'), {
                type: 'bar',
                data: { labels: citySorted.map(d => d[0]), datasets: [{ label: 'Count', data: citySorted.map(d => d[1]), backgroundColor: 'rgba(46,49,146,0.8)', borderRadius: 6 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            });

            if (charts.equipmentByBrand) charts.equipmentByBrand.destroy();
            charts.equipmentByBrand = new Chart(document.getElementById('equipmentByBrandChart').getContext('2d'), {
                type: 'doughnut',
                data: { labels: brandSorted.map(d => d[0]), datasets: [{ data: brandSorted.map(d => d[1]), backgroundColor: ['#2E3192', '#80D1E9', '#92A185', '#DEC18C', '#AD8082', '#4472C4', '#002060', '#7B2D8E'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 12 } } } }
            });

            NesmaChartDrill.attach(charts.equipmentByCity, function(label) {
                var recs = data.filter(function(r){ return r.city === label; });
                return { title: 'Equipment in ' + label, data: recs, columns: equipCols, subtitle: recs.length + ' items' };
            });
            NesmaChartDrill.attach(charts.equipmentByBrand, function(label) {
                var recs = data.filter(function(r){ return r.brand === label; });
                return { title: label + ' Equipment', data: recs, columns: equipCols, subtitle: recs.length + ' items' };
            });

            document.getElementById('equipmentCount').textContent = data.length + ' items';
            const tbody = document.getElementById('equipmentTableBody');
            tbody.textContent = '';
            data.slice(0, 100).forEach((r, i) => {
                const tr = document.createElement('tr');
                const cells = [i + 1, escapeHtml(r.description?.substring(0, 40) || ''), escapeHtml(r.brand), escapeHtml(r.capacity), escapeHtml(r.city), escapeHtml(r.project), escapeHtml(r.responsible), r.status, r.cost?.toLocaleString() || 0];
                cells.forEach((c, idx) => {
                    const td = document.createElement('td');
                    if (idx === 7) {
                        const badge = document.createElement('span');
                        badge.className = 'badge ' + (c === 'Active' ? 'badge-success' : 'badge-warning');
                        badge.textContent = c;
                        td.appendChild(badge);
                    } else if (idx === 8) {
                        td.className = 'font-semibold';
                        td.textContent = c;
                    } else {
                        td.textContent = c;
                    }
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        }

        function filterFleet() {
            const search = document.getElementById('fleetSearch').value.toLowerCase();
            const type = document.getElementById('filterFleetType').value;
            const region = document.getElementById('filterFleetRegion').value;
            const make = document.getElementById('filterFleetMake').value;
            filteredData.fleet = assetsData.records.fleet.filter(r => {
                const matchSearch = !search || r.make.toLowerCase().includes(search) || r.model.toLowerCase().includes(search) || r.plate_no_eng.toLowerCase().includes(search);
                const matchType = !type || r.vehicle_type === type;
                const matchRegion = !region || r.region === region;
                const matchMake = !make || r.make === make;
                return matchSearch && matchType && matchRegion && matchMake;
            });
            renderFleetTab();
        }

        function renderFleetTab() {
            const data = filteredData.fleet;
            const total = data.length;
            const active = data.filter(r => r.availability === 'ACTIVE').length;
            const types = new Set(data.map(r => r.vehicle_type).filter(t => t)).size;
            const totalCost = data.reduce((s, r) => s + r.cost, 0);

            const fleetCols = [{key:'plate_no_eng',label:'Plate'},{key:'make',label:'Make'},{key:'model',label:'Model'},{key:'vehicle_type',label:'Type'},{key:'year',label:'Year'},{key:'region',label:'Region'},{key:'city',label:'City'},{key:'user_name',label:'User'},{key:'availability',label:'Status'}];
            const kpisContainer = document.getElementById('fleetKPIs');
            kpisContainer.textContent = '';
            [
                { value: total, label: 'Total Vehicles', click: function(){ NesmaModal.show('All Fleet Vehicles', data, fleetCols); } },
                { value: active, label: 'Active', color: '#059669', click: function(){ NesmaModal.show('Active Vehicles', data.filter(function(r){return r.availability==='ACTIVE';}), fleetCols); } },
                { value: types, label: 'Vehicle Types', click: function(){ var ts={}; data.forEach(function(r){if(r.vehicle_type){if(!ts[r.vehicle_type])ts[r.vehicle_type]={type:r.vehicle_type,count:0}; ts[r.vehicle_type].count++;}}); NesmaModal.show('Vehicle Types', Object.values(ts), [{key:'type',label:'Type'},{key:'count',label:'Count',align:'right'}]); } },
                { value: 'SAR ' + (totalCost/1e6).toFixed(1) + 'M', label: 'Total Value', click: function(){ NesmaModal.show('Fleet by Value', data.slice().sort(function(a,b){return b.cost-a.cost;}), fleetCols); } }
            ].forEach(k => {
                const div = document.createElement('div');
                div.className = 'kpi-mini';
                div.style.cursor = 'pointer';
                if (k.click) div.onclick = k.click;
                const val = document.createElement('div');
                val.className = 'value';
                val.textContent = typeof k.value === 'number' ? k.value.toLocaleString() : k.value;
                if (k.color) val.style.color = k.color;
                const lbl = document.createElement('div');
                lbl.className = 'label';
                lbl.textContent = k.label;
                div.appendChild(val);
                div.appendChild(lbl);
                kpisContainer.appendChild(div);
            });

            const typeData = {};
            const regionData = {};
            data.forEach(r => {
                if (r.vehicle_type) typeData[r.vehicle_type] = (typeData[r.vehicle_type] || 0) + 1;
                if (r.region) regionData[r.region] = (regionData[r.region] || 0) + 1;
            });
            const typeSorted = Object.entries(typeData).sort((a, b) => b[1] - a[1]);
            const regionSorted = Object.entries(regionData).sort((a, b) => b[1] - a[1]);

            if (charts.fleetByType) charts.fleetByType.destroy();
            charts.fleetByType = new Chart(document.getElementById('fleetByTypeChart').getContext('2d'), {
                type: 'bar',
                data: { labels: typeSorted.map(d => d[0]), datasets: [{ label: 'Count', data: typeSorted.map(d => d[1]), backgroundColor: 'rgba(16,185,129,0.8)', borderRadius: 6 }] },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } } }
            });

            if (charts.fleetByRegion) charts.fleetByRegion.destroy();
            charts.fleetByRegion = new Chart(document.getElementById('fleetByRegionChart').getContext('2d'), {
                type: 'pie',
                data: { labels: regionSorted.map(d => d[0]), datasets: [{ data: regionSorted.map(d => d[1]), backgroundColor: ['#2E3192', '#92A185', '#DEC18C', '#AD8082', '#4472C4', '#7B2D8E'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
            });

            NesmaChartDrill.attach(charts.fleetByType, function(label) {
                var recs = data.filter(function(r){ return r.vehicle_type === label; });
                return { title: label + ' Vehicles', data: recs, columns: fleetCols, subtitle: recs.length + ' vehicles' };
            });
            NesmaChartDrill.attach(charts.fleetByRegion, function(label) {
                var recs = data.filter(function(r){ return r.region === label; });
                return { title: 'Fleet in ' + label, data: recs, columns: fleetCols, subtitle: recs.length + ' vehicles' };
            });

            document.getElementById('fleetCount').textContent = data.length + ' vehicles';
            const tbody = document.getElementById('fleetTableBody');
            tbody.textContent = '';
            data.slice(0, 100).forEach((r, i) => {
                const tr = document.createElement('tr');
                const cells = [i + 1, r.plate_no_eng, r.make + ' ' + r.model, r.vehicle_type, r.year || '-', r.region, r.city, (r.user_name || '').substring(0, 25), r.availability];
                cells.forEach((c, idx) => {
                    const td = document.createElement('td');
                    if (idx === 1) {
                        const badge = document.createElement('span');
                        badge.className = 'badge badge-info';
                        badge.textContent = escapeHtml(c);
                        td.appendChild(badge);
                    } else if (idx === 8) {
                        const badge = document.createElement('span');
                        badge.className = 'badge ' + (c === 'ACTIVE' ? 'badge-success' : 'badge-warning');
                        badge.textContent = escapeHtml(c);
                        td.appendChild(badge);
                    } else {
                        td.textContent = escapeHtml(c);
                    }
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        }

        function filterGenerators() {
            const search = document.getElementById('generatorSearch').value.toLowerCase();
            const type = document.getElementById('filterGenType').value;
            const capacity = document.getElementById('filterGenCapacity').value;
            const location = document.getElementById('filterGenLocation').value;
            const condition = document.getElementById('filterGenCondition').value;
            const status = document.getElementById('filterGenStatus').value;
            filteredData.generators = assetsData.records.generators.filter(r => {
                const matchSearch = !search || (r.name || '').toLowerCase().includes(search) || (r.location || '').toLowerCase().includes(search);
                const matchType = !type || r.type === type;
                const matchCapacity = !capacity || r.capacity === capacity;
                const matchLocation = !location || r.location === location;
                const matchCondition = !condition || r.condition === condition;
                const matchStatus = !status || r.status === status;
                return matchSearch && matchType && matchCapacity && matchLocation && matchCondition && matchStatus;
            });
            renderGeneratorsTab();
        }

        function resetGenFilters() {
            document.getElementById('generatorSearch').value = '';
            document.getElementById('filterGenType').value = '';
            document.getElementById('filterGenCapacity').value = '';
            document.getElementById('filterGenLocation').value = '';
            document.getElementById('filterGenCondition').value = '';
            document.getElementById('filterGenStatus').value = '';
            filteredData.generators = [...assetsData.records.generators];
            renderGeneratorsTab();
        }
        
        function filterGeneratorsByType(type) {
            switchTab('generators');
            document.getElementById('filterGenType').value = type;
            filterGenerators();
        }

        function renderGeneratorsTab() {
            const data = filteredData.generators;
            
            // Calculate stats from FILTERED data
            const nitData = data.filter(r => r.type === 'NIT');
            const rentalData = data.filter(r => r.type === 'Rental');
            
            // NIT Stats from filtered data
            const nitActive = nitData.filter(r => r.status === 'Active').length;
            const nitOverhaul = nitData.filter(r => r.status === 'Overhaul').length;
            const nitGood = nitData.filter(r => r.condition === 'Good').length;
            const nitMaint = nitData.filter(r => ['Needs Maintenance', 'Not Working', 'Bad'].includes(r.condition)).length;
            const nitKW = nitData.reduce((s, r) => s + (r.max_kw || 0), 0);
            const nitCost = nitData.reduce((s, r) => s + (r.cost || 0), 0);
            
            // Rental Stats from filtered data
            const rentalActive = rentalData.filter(r => r.status === 'Active').length;
            const rentalDemob = rentalData.filter(r => r.status === 'Demobilized').length;
            const rentalGood = rentalData.filter(r => r.condition === 'Good').length;
            const rentalMaint = rentalData.filter(r => ['Needs Maintenance', 'Not Working', 'Bad'].includes(r.condition)).length;
            const rentalKW = rentalData.reduce((s, r) => s + (r.max_kw || 0), 0);
            const rentalCost = rentalData.reduce((s, r) => s + (r.cost || 0), 0);

            // Update NIT Card
            document.getElementById('nitTotal').textContent = nitData.length;
            document.getElementById('nitActive').textContent = nitActive;
            document.getElementById('nitOverhaul').textContent = nitOverhaul;
            document.getElementById('nitGood').textContent = nitGood;
            document.getElementById('nitMaintenance').textContent = nitMaint;
            document.getElementById('nitKW').textContent = nitKW.toLocaleString();
            document.getElementById('nitCost').textContent = nitCost.toLocaleString();

            // Update Rental Card
            document.getElementById('rentalTotal').textContent = rentalData.length;
            document.getElementById('rentalActive').textContent = rentalActive;
            document.getElementById('rentalDemobilized').textContent = rentalDemob;
            document.getElementById('rentalGood').textContent = rentalGood;
            document.getElementById('rentalMaintenance').textContent = rentalMaint;
            document.getElementById('rentalKW').textContent = rentalKW.toLocaleString();
            document.getElementById('rentalCost').textContent = rentalCost.toLocaleString();

            // NESMA Colors
            const nesmaBlue = '#2E3192';
            const nesmaCyan = '#80D1E9';
            const nesmaNavy = '#0E2841';
            const nesmaGold = '#DEC18C';

            // Comparison Chart with NESMA colors
            if (charts.genComparison) charts.genComparison.destroy();
            charts.genComparison = new Chart(document.getElementById('genComparisonChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['Total', 'Active', 'Good Condition', 'Capacity (kW/100)'],
                    datasets: [
                        { label: 'NIT', data: [nitData.length, nitActive, nitGood, Math.round(nitKW/100)], backgroundColor: nesmaBlue, borderRadius: 6 },
                        { label: 'Rental', data: [rentalData.length, rentalActive, rentalGood, Math.round(rentalKW/100)], backgroundColor: nesmaGold, borderRadius: 6 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } }, scales: { y: { beginAtZero: true } } }
            });

            // Condition Chart with NESMA colors
            const condData = { Good: 0, 'Needs Maintenance': 0, 'Not Working': 0, Bad: 0, Unknown: 0 };
            data.forEach(r => { const c = r.condition || 'Unknown'; if (condData.hasOwnProperty(c)) condData[c]++; else condData['Unknown']++; });
            if (charts.genCondition) charts.genCondition.destroy();
            charts.genCondition = new Chart(document.getElementById('genConditionChart').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(condData).filter(k => condData[k] > 0),
                    datasets: [{ data: Object.values(condData).filter(v => v > 0), backgroundColor: [nesmaBlue, nesmaGold, '#AD8082', '#92A185', nesmaCyan], borderWidth: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
            });

            // Location Chart with NESMA colors
            const locData = {};
            data.forEach(r => { if (r.location) { if (!locData[r.location]) locData[r.location] = { count: 0, kw: 0 }; locData[r.location].count++; locData[r.location].kw += r.max_kw || 0; } });
            const locSorted = Object.entries(locData).sort((a, b) => b[1].kw - a[1].kw).slice(0, 10);
            if (charts.generatorsByLocation) charts.generatorsByLocation.destroy();
            charts.generatorsByLocation = new Chart(document.getElementById('generatorsByLocationChart').getContext('2d'), {
                type: 'bar',
                data: { labels: locSorted.map(d => d[0].length > 18 ? d[0].substring(0,18) + '...' : d[0]), datasets: [{ label: 'Capacity (kW)', data: locSorted.map(d => d[1].kw), backgroundColor: nesmaCyan, borderRadius: 6 }] },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true } } }
            });

            const genCols = [{key:'type',label:'Type'},{key:'name',label:'Name'},{key:'capacity',label:'Capacity'},{key:'max_kw',label:'Max kW',align:'right'},{key:'location',label:'Location'},{key:'condition',label:'Condition'},{key:'responsible',label:'Responsible'},{key:'status',label:'Status'},{key:'cost',label:'Cost',align:'right'}];
            NesmaChartDrill.attach(charts.generatorsByLocation, function(label) {
                var fullLabel = Object.keys(locData).find(k => k.startsWith(label.replace('...', '')));
                var recs = data.filter(function(r){ return r.location === fullLabel; });
                return { title: 'Generators at ' + fullLabel, data: recs, columns: genCols, subtitle: recs.length + ' generators' };
            });

            // Table
            document.getElementById('generatorCount').textContent = data.length + ' generators';
            const tbody = document.getElementById('generatorTableBody');
            tbody.textContent = '';
            data.forEach((r, i) => {
                const tr = document.createElement('tr');
                const typeBadge = r.type === 'NIT' ? '<span class="badge" style="background:#E8EAF6;color:#2E3192;">NIT</span>' : '<span class="badge" style="background:#FDF6E3;color:#B8860B;">Rental</span>';
                const condBadge = r.condition === 'Good' ? '<span class="badge" style="background:#E8EAF6;color:#2E3192;">Good</span>' : r.condition === 'Needs Maintenance' ? '<span class="badge" style="background:#FDF6E3;color:#B8860B;">Needs Maint.</span>' : r.condition === 'Not Working' || r.condition === 'Bad' ? '<span class="badge badge-danger">' + escapeHtml(r.condition) + '</span>' : '<span class="badge" style="background:#F3F4F6;color:#6B7280;">' + escapeHtml(r.condition || 'Unknown') + '</span>';
                const statusBadge = r.status === 'Active' ? '<span class="badge" style="background:#E0F7FA;color:#0E2841;">Active</span>' : r.status === 'Overhaul' ? '<span class="badge badge-purple">Overhaul</span>' : r.status === 'Demobilized' ? '<span class="badge" style="background:#F3F4F6;color:#6B7280;">Demobilized</span>' : '<span class="badge" style="background:#E8EAF6;color:#2E3192;">' + escapeHtml(r.status || 'Unknown') + '</span>';
                tr.innerHTML = '<td>' + (i+1) + '</td><td>' + typeBadge + '</td><td><strong>' + escapeHtml(r.name || '-') + '</strong></td><td>' + escapeHtml(r.capacity || '-') + '</td><td class="font-semibold" style="color:#2E3192;">' + (r.max_kw || 0) + '</td><td>' + escapeHtml(r.location || '-') + '</td><td>' + condBadge + '</td><td>' + escapeHtml(r.responsible || '-') + '</td><td>' + statusBadge + '</td><td class="text-right">' + (r.cost ? r.cost.toLocaleString() : '-') + '</td>';
                tbody.appendChild(tr);
            });
        }

        function filterACs() {
            const search = document.getElementById('acsSearch').value.toLowerCase();
            const project = document.getElementById('filterAcsProject').value;
            const status = document.getElementById('filterAcsStatus').value;
            filteredData.acs = assetsData.records.stand_acs.filter(r => {
                const matchSearch = !search || (r.description || '').toLowerCase().includes(search);
                const matchProject = !project || r.project_code === project;
                const matchStatus = !status || r.status === status;
                return matchSearch && matchProject && matchStatus;
            });
            renderACsTab();
        }

        function renderACsTab() {
            const data = filteredData.acs;
            const total = data.length;
            const available = data.reduce((s, r) => s + r.qty_available, 0);
            const required = data.reduce((s, r) => s + r.qty_required, 0);
            const totalCost = data.reduce((s, r) => s + r.cost, 0);

            const acsCols = [{key:'description',label:'Description'},{key:'project_code',label:'Project'},{key:'capacity',label:'Capacity'},{key:'qty_required',label:'Required',align:'right'},{key:'qty_available',label:'Available',align:'right'},{key:'cost',label:'Cost',align:'right'},{key:'status',label:'Status'}];
            const kpisContainer = document.getElementById('acsKPIs');
            kpisContainer.textContent = '';
            [
                { value: total, label: 'Total Units', click: function(){ NesmaModal.show('All Stand ACs', data, acsCols); } },
                { value: available, label: 'Available', color: '#059669', click: function(){ NesmaModal.show('Available ACs', data.filter(function(r){return r.qty_available > 0;}), acsCols, available + ' units available'); } },
                { value: required, label: 'Required', color: '#D97706', click: function(){ NesmaModal.show('Required ACs', data.filter(function(r){return r.qty_required > 0;}), acsCols, required + ' units required'); } },
                { value: 'SAR ' + totalCost.toLocaleString(), label: 'Total Cost', click: function(){ NesmaModal.show('ACs by Cost', data.slice().sort(function(a,b){return b.cost-a.cost;}), acsCols, 'SAR ' + totalCost.toLocaleString() + ' total'); } }
            ].forEach(k => {
                const div = document.createElement('div');
                div.className = 'kpi-mini';
                div.style.cursor = 'pointer';
                if (k.click) div.onclick = k.click;
                const val = document.createElement('div');
                val.className = 'value';
                val.textContent = k.value;
                if (k.color) val.style.color = k.color;
                const lbl = document.createElement('div');
                lbl.className = 'label';
                lbl.textContent = k.label;
                div.appendChild(val);
                div.appendChild(lbl);
                kpisContainer.appendChild(div);
            });

            document.getElementById('acsCount').textContent = data.length + ' units';
            const tbody = document.getElementById('acsTableBody');
            tbody.textContent = '';
            data.forEach((r, i) => {
                const tr = document.createElement('tr');
                const cells = [i + 1, (r.description || '').substring(0, 50), r.project_code, r.capacity, r.qty_required, r.qty_available, r.cost?.toLocaleString() || 0, r.status];
                cells.forEach((c, idx) => {
                    const td = document.createElement('td');
                    if (idx === 2) {
                        const badge = document.createElement('span');
                        badge.className = 'badge badge-info';
                        badge.textContent = escapeHtml(c);
                        td.appendChild(badge);
                    } else if (idx === 5) {
                        td.className = 'font-semibold';
                        td.style.color = '#059669';
                        td.textContent = c;
                    } else if (idx === 7) {
                        const badge = document.createElement('span');
                        badge.className = 'badge ' + (c === 'Active' ? 'badge-success' : c === 'Energized' ? 'badge-info' : 'badge-warning');
                        badge.textContent = escapeHtml(c);
                        td.appendChild(badge);
                    } else {
                        td.textContent = escapeHtml(c);
                    }
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        }

        function filterTesting() {
            const search = document.getElementById('testingSearch').value.toLowerCase();
            const supplier = document.getElementById('filterTestingSupplier').value;
            const location = document.getElementById('filterTestingLocation').value;
            const tuv = document.getElementById('filterTestingTUV').value;
            filteredData.testing = assetsData.records.testing_equipment.filter(r => {
                const matchSearch = !search || r.description.toLowerCase().includes(search) || r.supplier.toLowerCase().includes(search);
                const matchSupplier = !supplier || r.supplier === supplier;
                const matchLocation = !location || r.location === location;
                const matchTUV = !tuv || r.tuv === tuv;
                return matchSearch && matchSupplier && matchLocation && matchTUV;
            });
            renderTestingTab();
        }

        function renderTestingTab() {
            const data = filteredData.testing;
            const total = data.length;
            const totalValue = data.reduce((s, r) => s + r.total_price, 0);
            const calibrated = data.filter(r => r.calibration === 'New' || r.calibration === 'Valid').length;

            const testCols = [{key:'description',label:'Description'},{key:'supplier',label:'Supplier'},{key:'location',label:'Location'},{key:'tuv',label:'TUV'},{key:'calibration',label:'Calibration'},{key:'qty',label:'Qty',align:'right'},{key:'total_price',label:'Value',align:'right'}];
            const totalQtyTesting = data.reduce((s, r) => s + r.qty, 0);
            const kpisContainer = document.getElementById('testingKPIs');
            kpisContainer.textContent = '';
            [
                { value: total, label: 'Total Items', click: function(){ NesmaModal.show('All Testing Equipment', data, testCols); } },
                { value: calibrated, label: 'Calibrated', color: '#8B5CF6', click: function(){ NesmaModal.show('Calibrated Equipment', data.filter(function(r){return r.calibration==='New'||r.calibration==='Valid';}), testCols); } },
                { value: 'SAR ' + (totalValue/1e6).toFixed(2) + 'M', label: 'Total Value', click: function(){ NesmaModal.show('Equipment by Value', data.slice().sort(function(a,b){return b.total_price-a.total_price;}), testCols, 'SAR ' + totalValue.toLocaleString() + ' total'); } },
                { value: totalQtyTesting, label: 'Total Qty', click: function(){ NesmaModal.show('All Testing Equipment', data, testCols, totalQtyTesting + ' total quantity'); } }
            ].forEach(k => {
                const div = document.createElement('div');
                div.className = 'kpi-mini';
                div.style.cursor = 'pointer';
                if (k.click) div.onclick = k.click;
                const val = document.createElement('div');
                val.className = 'value';
                val.textContent = k.value;
                if (k.color) val.style.color = k.color;
                const lbl = document.createElement('div');
                lbl.className = 'label';
                lbl.textContent = k.label;
                div.appendChild(val);
                div.appendChild(lbl);
                kpisContainer.appendChild(div);
            });

            document.getElementById('testingCount').textContent = data.length + ' items';
            const tbody = document.getElementById('testingTableBody');
            tbody.textContent = '';
            data.forEach((r, i) => {
                const tr = document.createElement('tr');
                const cells = [i + 1, (r.description || '').substring(0, 45), r.supplier, r.location, r.tuv, r.calibration, r.qty, r.total_price?.toLocaleString() || 0];
                cells.forEach((c, idx) => {
                    const td = document.createElement('td');
                    if (idx === 4 || idx === 5) {
                        const badge = document.createElement('span');
                        badge.className = 'badge ' + (c === 'New' ? 'badge-success' : 'badge-warning');
                        badge.textContent = escapeHtml(c);
                        td.appendChild(badge);
                    } else if (idx === 7) {
                        td.className = 'font-semibold';
                        td.textContent = c;
                    } else {
                        td.textContent = escapeHtml(c);
                    }
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        }

        function filterTools() {
            const search = document.getElementById('toolsSearch').value.toLowerCase();
            const type = document.getElementById('filterToolType').value;
            const location = document.getElementById('filterToolLocation').value;
            filteredData.tools = assetsData.records.tools.filter(r => {
                const matchSearch = !search || r.description.toLowerCase().includes(search);
                const matchType = !type || r.type === type;
                const matchLocation = !location || r.location === location;
                return matchSearch && matchType && matchLocation;
            });
            renderToolsTab();
        }

        function renderToolsTab() {
            const data = filteredData.tools;
            const total = data.length;
            const totalQty = data.reduce((s, r) => s + r.quantity, 0);
            const types = new Set(data.map(r => r.type).filter(t => t)).size;
            const valid = data.filter(r => r.tuv_status === 'Valid').length;

            const toolsCols = [{key:'description',label:'Description'},{key:'type',label:'Type'},{key:'supplier',label:'Supplier'},{key:'measurement',label:'Measurement'},{key:'location',label:'Location'},{key:'quantity',label:'Qty',align:'right'},{key:'tuv_status',label:'TUV Status'}];
            const kpisContainer = document.getElementById('toolsKPIs');
            kpisContainer.textContent = '';
            [
                { value: total, label: 'Total Tools', click: function(){ NesmaModal.show('All Tools', data, toolsCols); } },
                { value: totalQty.toLocaleString(), label: 'Total Quantity', color: '#EF4444', click: function(){ NesmaModal.show('Tools by Quantity', data.slice().sort(function(a,b){return b.quantity-a.quantity;}), toolsCols, totalQty.toLocaleString() + ' total qty'); } },
                { value: types, label: 'Types', click: function(){ var ts={}; data.forEach(function(r){if(r.type){if(!ts[r.type])ts[r.type]={type:r.type,count:0,qty:0}; ts[r.type].count++; ts[r.type].qty+=r.quantity;}}); NesmaModal.show('Tool Types', Object.values(ts), [{key:'type',label:'Type'},{key:'count',label:'Items',align:'right'},{key:'qty',label:'Qty',align:'right'}]); } },
                { value: valid, label: 'TUV Valid', color: '#059669', click: function(){ NesmaModal.show('TUV Valid Tools', data.filter(function(r){return r.tuv_status==='Valid';}), toolsCols); } }
            ].forEach(k => {
                const div = document.createElement('div');
                div.className = 'kpi-mini';
                div.style.cursor = 'pointer';
                if (k.click) div.onclick = k.click;
                const val = document.createElement('div');
                val.className = 'value';
                val.textContent = k.value;
                if (k.color) val.style.color = k.color;
                const lbl = document.createElement('div');
                lbl.className = 'label';
                lbl.textContent = k.label;
                div.appendChild(val);
                div.appendChild(lbl);
                kpisContainer.appendChild(div);
            });

            document.getElementById('toolsCount').textContent = data.length + ' tools';
            const tbody = document.getElementById('toolsTableBody');
            tbody.textContent = '';
            data.slice(0, 100).forEach((r, i) => {
                const tr = document.createElement('tr');
                const cells = [i + 1, (r.description || '').substring(0, 40), r.type, r.supplier, r.measurement, (r.location || '').substring(0, 25), r.quantity, r.tuv_status];
                cells.forEach((c, idx) => {
                    const td = document.createElement('td');
                    if (idx === 6) {
                        td.className = 'font-semibold';
                        td.textContent = c;
                    } else if (idx === 7) {
                        const badge = document.createElement('span');
                        badge.className = 'badge ' + (c === 'Valid' ? 'badge-success' : 'badge-warning');
                        badge.textContent = escapeHtml(c);
                        td.appendChild(badge);
                    } else {
                        td.textContent = escapeHtml(c);
                    }
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.closest('.tab-btn').classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');
        }

        function exportToExcel(type) {
            let data, filename;
            switch(type) {
                case 'equipment': data = filteredData.equipment; filename = 'equipment_export.xlsx'; break;
                case 'fleet': data = filteredData.fleet; filename = 'fleet_export.xlsx'; break;
                case 'generators': data = filteredData.generators; filename = 'generators_export.xlsx'; break;
                case 'acs': data = filteredData.acs; filename = 'stand_acs_export.xlsx'; break;
                case 'testing': data = filteredData.testing; filename = 'testing_equipment_export.xlsx'; break;
                case 'tools': data = filteredData.tools; filename = 'tools_export.xlsx'; break;
            }
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Data');
            XLSX.writeFile(wb, filename);
        }

        document.addEventListener('DOMContentLoaded', function() { loadData(); if (typeof NesmaTheme !== 'undefined') NesmaTheme.init(); });
    </script>
</body>
</html>
